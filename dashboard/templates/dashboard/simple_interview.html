{% extends "dashboard/base.html" %}

{% block title %}Simple Interview Practice{% endblock %}

{% block page_title %}Simple Interview Practice{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto py-8">
    
    <!-- Header -->
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-primary-800 mb-4">AI Interview Practice</h2>
        <p class="text-lg text-primary-600">
            Answer the interview question below and get instant AI feedback
        </p>
    </div>

    <!-- Interview Card -->
    <div class="bg-white rounded-2xl shadow-lg p-8 border border-primary-200">
        
        {% if not submitted %}
        <!-- Question Form -->
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Question Display -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i data-lucide="help-circle" class="w-6 h-6 text-blue-500"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">Interview Question:</h3>
                        <p class="text-blue-700 text-lg leading-relaxed">{{ question }}</p>
                    </div>
                </div>
            </div>

            <!-- Answer Input -->
            <div>
                <label for="answer" class="block text-sm font-semibold text-primary-700 mb-3">
                    Your Answer:
                </label>
                <div class="relative">
                    <textarea 
                        name="answer" 
                        id="answer" 
                        rows="8" 
                        class="w-full p-4 pr-16 border border-primary-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-primary-800 placeholder-primary-500"
                        placeholder="Type your detailed answer here or click the microphone to speak..."
                        required></textarea>
                    
                    <!-- Microphone Button -->
                    <button 
                        type="button" 
                        id="micButton"
                        class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
                        title="Click to speak">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <!-- Speech Status -->
                <div id="speechStatus" class="mt-2 text-sm text-gray-600 hidden">
                    <span id="statusText">Ready to listen...</span>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button 
                    type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i data-lucide="send" class="w-5 h-5 mr-2 inline-block"></i>
                    Submit Answer
                </button>
            </div>
        </form>

        {% else %}
        <!-- Feedback Display -->
        <div class="space-y-6">
            
            <!-- Your Answer -->
            <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-r-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i data-lucide="user" class="w-6 h-6 text-green-500"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-2">Your Answer:</h3>
                        <p class="text-green-700 leading-relaxed">{{ user_answer }}</p>
                    </div>
                </div>
            </div>

            <!-- AI Feedback -->
            <div class="bg-purple-50 border-l-4 border-purple-500 p-6 rounded-r-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i data-lucide="brain" class="w-6 h-6 text-purple-500"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-purple-800 mb-2">AI Feedback:</h3>
                        <div class="text-purple-700 leading-relaxed whitespace-pre-line">{{ feedback }}</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 pt-4">
                <a href="{% url 'dashboard:simple_interview' %}" 
                   class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-300">
                    <i data-lucide="refresh-cw" class="w-5 h-5 mr-2 inline-block"></i>
                    Try Another Question
                </a>
                <a href="{% url 'dashboard:dashboard' %}" 
                   class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-300">
                    <i data-lucide="home" class="w-5 h-5 mr-2 inline-block"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
        {% endif %}
        
    </div>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
    lucide.createIcons();
    
    // Speech-to-Text functionality
    document.addEventListener('DOMContentLoaded', function() {
        const micButton = document.getElementById('micButton');
        const answerTextarea = document.getElementById('answer');
        const speechStatus = document.getElementById('speechStatus');
        const statusText = document.getElementById('statusText');
        
        let recognition;
        let isListening = false;
        
        // Check if browser supports speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Configure speech recognition
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            // Speech recognition event handlers
            recognition.onstart = function() {
                isListening = true;
                micButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                micButton.classList.add('bg-green-500', 'hover:bg-green-600', 'pulse-animation');
                micButton.querySelector('i').setAttribute('data-lucide', 'mic');
                lucide.createIcons();
                speechStatus.classList.remove('hidden');
                statusText.textContent = 'Listening... Speak now!';
                statusText.className = 'text-green-600 font-medium';
            };
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update textarea with the speech result
                if (finalTranscript) {
                    if (answerTextarea.value) {
                        answerTextarea.value += ' ' + finalTranscript;
                    } else {
                        answerTextarea.value = finalTranscript;
                    }
                }
                
                // Show interim results in status
                if (interimTranscript) {
                    statusText.textContent = 'Hearing: "' + interimTranscript + '"';
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                micButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'pulse-animation');
                micButton.classList.add('bg-red-500', 'hover:bg-red-600');
                statusText.textContent = 'Error: ' + event.error + '. Click mic to try again.';
                statusText.className = 'text-red-600 font-medium';
            };
            
            recognition.onend = function() {
                isListening = false;
                micButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'pulse-animation');
                micButton.classList.add('bg-red-500', 'hover:bg-red-600');
                micButton.querySelector('i').setAttribute('data-lucide', 'mic');
                lucide.createIcons();
                statusText.textContent = 'Finished listening. Click mic to speak again.';
                statusText.className = 'text-gray-600';
            };
            
            // Microphone button click handler
            micButton.addEventListener('click', function() {
                if (!isListening) {
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Failed to start speech recognition:', error);
                        statusText.textContent = 'Failed to start microphone. Please try again.';
                        statusText.className = 'text-red-600 font-medium';
                        speechStatus.classList.remove('hidden');
                    }
                } else {
                    recognition.stop();
                }
            });
            
        } else {
            // Browser doesn't support speech recognition
            micButton.addEventListener('click', function() {
                speechStatus.classList.remove('hidden');
                statusText.textContent = 'Speech recognition not supported in this browser. Please type your answer.';
                statusText.className = 'text-yellow-600 font-medium';
            });
        }
    });
</script>

<style>
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: .5;
        }
    }
</style>

{% endblock %}
