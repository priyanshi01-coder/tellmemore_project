{% extends "dashboard/base.html" %}

{% block title %}AI Interview Session{% endblock %}

{% block page_title %}AI Interview Session{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    /* Clean Professional AI Interface Styling */
    .ai-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .ai-card:hover {
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Typing Animation for AI Response */
    .typing-cursor::after {
        content: "|";
        display: inline-block;
        color: #3B82F6;
        margin-left: 2px;
        animation: blink-caret 0.7s step-end infinite;
    }

    @keyframes blink-caret {

        from,
        to {
            opacity: 0
        }

        50% {
            opacity: 1;
        }
    }

    /* Pulse Animation for Active States */
    .pulse-blue {
        animation: pulse-blue-anim 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .pulse-glow-purple {
        animation: pulse-purple-anim 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .pulse-glow-pink {
        animation: pulse-pink-anim 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-blue-anim {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
        }

        50% {
            box-shadow: 0 0 8px 4px rgba(59, 130, 246, 0.6), 0 0 0 8px rgba(59, 130, 246, 0.1);
        }
    }

    @keyframes pulse-purple-anim {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4);
        }

        50% {
            box-shadow: 0 0 8px 4px rgba(147, 51, 234, 0.6), 0 0 0 8px rgba(147, 51, 234, 0.1);
        }
    }

    @keyframes pulse-pink-anim {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.4);
        }

        50% {
            box-shadow: 0 0 8px 4px rgba(236, 72, 153, 0.6), 0 0 0 8px rgba(236, 72, 153, 0.1);
        }
    }

    /* Timer Critical State */
    .timer-critical {
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
        background-color: rgba(239, 68, 68, 0.1);
    }

    /* Custom Scrollbar for Chat Display */
    #chat-display::-webkit-scrollbar {
        width: 8px;
    }

    #chat-display::-webkit-scrollbar-thumb {
        background-color: #3B82F6;
        border-radius: 4px;
    }

    #chat-display::-webkit-scrollbar-track {
        background-color: #F1F5F9;
    }

    /* Message bubbles */
    .message-ai {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .message-user {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.05));
        border: 1px solid rgba(34, 197, 94, 0.2);
    }
</style>
{% endblock %}

{% block content %}

<!-- Header Section -->
<div class="mb-8">
    <div class="text-center">
        <h2 class="text-4xl font-bold text-primary-800 mb-4">AI Interview Session</h2>
        <p class="text-xl text-primary-600 max-w-3xl mx-auto">
            Practice with our AI interviewer. Get real-time feedback and improve your interview performance.
        </p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">

    <!-- Control Panel -->
    <div id="ai-panel" class="lg:col-span-1 flex flex-col space-y-6">
        <div class="ai-card rounded-3xl p-6 h-full flex flex-col">
            <h3 class="text-2xl font-bold text-primary-800 border-b border-primary-200 pb-4 mb-6 flex items-center">
                <i data-lucide="settings" class="w-6 h-6 mr-3 text-accent-500"></i>
                Session Control
            </h3>

            <div class="space-y-4 flex-1">

                <!-- System Status -->
                <div class="p-4 bg-primary-50 rounded-xl border border-primary-200">
                    <p class="text-sm font-semibold text-accent-600 flex items-center mb-2">
                        <i data-lucide="monitor" class="w-4 h-4 mr-2"></i> System Status
                    </p>
                    <p id="ai-status" class="text-sm text-primary-600">
                        Click 'Start Session' below to begin your AI interview practice.
                    </p>
                </div>

                <!-- Timer -->
                <div class="p-4 bg-primary-50 rounded-xl border border-primary-200">
                    <p class="text-sm font-semibold text-accent-600 flex items-center mb-2">
                        <i data-lucide="clock" class="w-4 h-4 mr-2"></i> Answer Time Remaining
                    </p>
                    <div id="answer-timer"
                        class="text-3xl font-mono font-bold px-3 py-2 mt-2 rounded-lg text-center bg-white border border-primary-300 w-full transition-colors duration-500 text-primary-800">
                        00:00
                    </div>
                </div>

            </div>

            <!-- Control Buttons -->
            <div class="pt-6 border-t border-primary-200 flex flex-col space-y-4 mt-auto">
                <button id="start-session-btn"
                    class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 text-lg">
                    <i data-lucide="play" class="w-5 h-5 mr-2 inline-block"></i> Start Session
                </button>
                <div class="flex space-x-4">
                    <button id="pause-btn" disabled
                        class="flex-1 px-4 py-3 bg-accent-500 hover:bg-accent-600 text-white font-semibold rounded-xl shadow-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="pause" class="w-5 h-5 mr-1 inline-block"></i> <span id="pause-text">Pause</span>
                    </button>
                    <button id="start-over-btn"
                        class="flex-1 px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-xl shadow-lg transition-all duration-300">
                        <i data-lucide="rotate-ccw" class="w-5 h-5 mr-1 inline-block"></i> Reset
                    </button>
                </div>
                <button id="end-session-btn" disabled
                    class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="square" class="w-5 h-5 mr-2 inline-block"></i> End Session
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="lg:col-span-2 flex flex-col">
        <div class="ai-card rounded-3xl p-6 h-[80vh] min-h-[600px] flex flex-col">

            <h3 class="text-2xl font-bold text-primary-800 border-b border-primary-200 pb-4 mb-6 flex items-center">
                <i data-lucide="message-circle" class="w-6 h-6 mr-3 text-accent-500"></i>
                Interview Chat
            </h3>

            <!-- Chat Display -->
            <div id="chat-display" class="flex-grow overflow-y-auto space-y-4 p-2 mb-6 scroll-smooth">

                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="max-w-xs sm:max-w-lg message-ai p-4 rounded-2xl rounded-tl-sm shadow-sm">
                        <p class="font-semibold text-accent-600 mb-2 flex items-center text-sm">
                            <i data-lucide="bot" class="w-4 h-4 mr-2"></i> AI Interviewer
                        </p>
                        <p class="text-primary-700 text-sm leading-relaxed">
                            Welcome to your AI interview practice session. I'm here to help you improve your interview
                            skills.
                            Click 'Start Session' on the left to begin our conversation.
                        </p>
                    </div>
                </div>

                <!-- AI Message Template -->
                <div id="ai-message-template" class="flex justify-start hidden">
                    <div
                        class="max-w-xs sm:max-w-lg message-ai p-4 rounded-2xl rounded-tl-sm shadow-sm opacity-0 transform translate-y-4 transition-all duration-300">
                        <p class="font-semibold text-accent-600 mb-2 flex items-center text-sm">
                            <i data-lucide="brain" class="w-4 h-4 mr-2"></i> AI Interviewer
                        </p>
                        <p class="text-primary-700 text-sm leading-relaxed" data-message-content></p>
                    </div>
                </div>

                <!-- User Message Template -->
                <div id="user-message-template" class="flex justify-end hidden">
                    <div
                        class="max-w-xs sm:max-w-lg message-user p-4 rounded-2xl rounded-br-sm shadow-sm opacity-0 transform translate-y-4 transition-all duration-300">
                        <p class="font-semibold text-green-600 mb-2 flex items-center text-sm">
                            <i data-lucide="user" class="w-4 h-4 mr-2"></i> You
                        </p>
                        <p class="text-primary-700 text-sm leading-relaxed" data-message-content></p>
                    </div>
                </div>

            </div>

            <!-- Input Area -->
            <div class="flex items-center space-x-4 pt-4 border-t border-primary-200">

                <!-- AI Button -->
                <button id="ai-interaction-btn" disabled
                    class="relative p-3 rounded-full bg-accent-500 hover:bg-accent-600 text-white transition-all duration-300 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Ask AI for next step">
                    <i id="ai-mic-icon" data-lucide="message-square-text" class="w-6 h-6"></i>
                    <span id="ai-prompt-text"
                        class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-medium text-accent-600 opacity-0 transition-opacity duration-300 whitespace-nowrap">AI
                        Ready</span>
                </button>

                <!-- Text Input -->
                <div class="relative flex-grow">
                    <input type="text" id="chat-input" placeholder="Type your response here..."
                        class="w-full p-3 pl-5 pr-14 bg-white rounded-full border border-primary-300 text-primary-800 placeholder-primary-500 focus:border-accent-500 focus:ring-2 focus:ring-accent-200 transition-colors duration-200 disabled:opacity-70 disabled:bg-primary-50"
                        disabled>
                    {% csrf_token %}
                    <button id="send-btn" disabled
                        class="absolute right-1 top-1/2 transform -translate-y-1/2 p-2 bg-accent-500 hover:bg-accent-600 rounded-full transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="send" class="w-5 h-5 text-white"></i>
                    </button>
                </div>

                <!-- Voice Button -->
                <button id="user-interaction-btn" disabled
                    class="relative p-3 rounded-full bg-green-500 hover:bg-green-600 text-white transition-all duration-300 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Start/Stop recording">
                    <i id="user-mic-icon" data-lucide="mic" class="w-6 h-6"></i>
                    <span id="user-prompt-text"
                        class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-medium text-green-600 opacity-0 transition-opacity duration-300 whitespace-nowrap">Voice</span>
                </button>

            </div>
        </div>
    </div>

</div>
</div>

<!-- Modal -->
<div id="custom-modal"
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 hidden">
    <div
        class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-90 border border-primary-200 text-center">
        <p id="modal-message" class="text-lg font-semibold mb-6 text-primary-800"></p>
        <div id="modal-actions" class="flex justify-center space-x-4">
            <button id="modal-cancel"
                class="px-5 py-2 bg-primary-200 hover:bg-primary-300 text-primary-700 rounded-lg transition-all duration-300 hidden">Cancel</button>
            <button id="modal-ok"
                class="px-5 py-2 bg-accent-500 hover:bg-accent-600 rounded-lg transition-all duration-300 text-white font-bold">OK</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Lucide Icons
    lucide.createIcons();
</script>

<script>
    // Safe parsing of Django data
    let interviewData = {};
    try {
        {% if interview_details %}
        interviewData = {
            time_per_question: {{ interview_details.time_per_question |default: 60 }
    },
    role: "{{ interview_details.role|default:'Software Developer'|escapejs }}",
        skills: "{{ interview_details.skills|default:'Python, JavaScript, Problem Solving'|escapejs }}",
            difficulty: "{{ interview_details.difficulty|default:'medium'|escapejs }}",
                mode: "{{ interview_details.mode|default:'technical'|escapejs }}",
                    experience: "{{ interview_details.experience|default:''|escapejs }}",
                        about_you: "{{ interview_details.about_you|default:''|escapejs }}"
        };
    {% else %}
    interviewData = {
        time_per_question: 60,
        role: 'Software Developer',
        skills: 'Python, JavaScript, Problem Solving',
        difficulty: 'medium',
        mode: 'technical',
        experience: '',
        about_you: ''
    };
    {% endif %}
    } catch (e) {
        console.error('Error parsing interview data:', e);
        interviewData = {
            time_per_question: 60,
            role: 'Software Developer',
            skills: 'Python, JavaScript, Problem Solving',
            difficulty: 'medium',
            mode: 'technical',
            experience: '',
            about_you: ''
        };
    }

    // Django variables for JavaScript
    window.interviewConfig = {
        timePerQuestion: interviewData.time_per_question || 60,
        position: interviewData.role || 'Software Developer',
        skills: interviewData.skills || 'Python, JavaScript, Problem Solving',
        difficulty: interviewData.difficulty || 'medium',
        mode: interviewData.mode || 'technical',
        experience: interviewData.experience || '',
        aboutYou: interviewData.about_you || ''
    };

    // CSRF Token for AJAX requests
    window.csrfToken = '{{ csrf_token }}';

    // Debug logging
    console.log('Interview Config:', window.interviewConfig);
</script>

<script>

    // --- Custom Modal (Tailwind Styled) ---
    const showModal = (message, isConfirm = false, onConfirm = () => { }) => {
        let modal = document.getElementById('custom-modal');
        const modalContent = modal.querySelector('div');
        const messageElement = document.getElementById('modal-message');
        const okBtn = document.getElementById('modal-ok');
        const cancelBtn = document.getElementById('modal-cancel');

        messageElement.textContent = message;

        if (isConfirm) {
            cancelBtn.classList.remove('hidden');
            okBtn.textContent = 'Confirm';
        } else {
            cancelBtn.classList.add('hidden');
            okBtn.textContent = 'OK';
        }

        // Clone to remove old listeners
        const newOk = okBtn.cloneNode(true);
        const newCancel = cancelBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOk, okBtn);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        const closeAndRemoveListeners = () => {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-90');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        };

        modal.querySelector('#modal-ok').addEventListener('click', () => {
            closeAndRemoveListeners();
            if (isConfirm) onConfirm(true);
            else onConfirm(); // For simple OK
        });
        modal.querySelector('#modal-cancel').addEventListener('click', () => {
            closeAndRemoveListeners();
            if (isConfirm) onConfirm(false);
        });

        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-90');
            modalContent.classList.add('scale-100');
        }, 10);
    };
    // --- End Custom Modal ---

    // --- Core Redesigned Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Constants & Elements ---
        const ANSWER_TIME_LIMIT = window.interviewConfig.timePerQuestion; // Seconds per question from user settings
        const AI_RESPONSE_SIM_DELAY = 40; // Time in ms per character for typing animation

        // Interview context from backend
        let interviewContext = {
            position: window.interviewConfig.position,
            skills: window.interviewConfig.skills,
            difficulty: window.interviewConfig.difficulty,
            mode: window.interviewConfig.mode,
            experience: window.interviewConfig.experience,
            about_you: window.interviewConfig.aboutYou
        };

        // Session management
        let currentSessionId = null;
        let speechRecognition = null;
        let isRecording = false;

        // Initialize Web Speech API
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = false;
            speechRecognition.interimResults = false;
            speechRecognition.lang = 'en-US';

            speechRecognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
                stopUserTurn(false, transcript);
            };

            speechRecognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                stopUserTurn(false, 'Error recognizing speech. Please try typing your answer.');
            };

            speechRecognition.onend = function () {
                isRecording = false;
                userMicIcon.setAttribute('data-lucide', 'mic');
                lucide.createIcons();
            };
        }
        const USER_RESPONSE_BANK = [
            "My team achieved a 15% efficiency increase in my previous role by implementing a new automated reporting system.",
            "In that project, I chose a microservices architecture, prioritizing scalability over initial development speed. The latency trade-off was minimal, but the deployment flexibility was a huge win.",
            "I influenced the marketing team by presenting clear data showing their current content was underperforming, leading them to adopt my proposed SEO strategy, which resulted in a 40% lead increase."
        ];

        const chatDisplay = document.getElementById('chat-display');
        const aiButton = document.getElementById('ai-interaction-btn');
        const userButton = document.getElementById('user-interaction-btn');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const aiPromptText = document.getElementById('ai-prompt-text');
        const userPromptText = document.getElementById('user-prompt-text');
        const aiMicIcon = document.getElementById('ai-mic-icon');
        const userMicIcon = document.getElementById('user-mic-icon');
        const answerTimerElement = document.getElementById('answer-timer');
        const aiStatusText = document.getElementById('ai-status');

        const startSessionBtn = document.getElementById('start-session-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const startOverBtn = document.getElementById('start-over-btn');
        const endSessionBtn = document.getElementById('end-session-btn');
        const pauseText = document.getElementById('pause-text');

        // --- State ---
        let isPaused = false;
        let sessionActive = false;
        let isUserRecording = false;
        let isAITalking = false;
        let currentAnswerSeconds = ANSWER_TIME_LIMIT;
        let answerTimerInterval = null;
        let currentQuestionIndex = 0;
        let typingTimeout = null;

        // --- Utility Functions ---
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        };

        const smoothScrollToBottom = () => {
            // Use requestAnimationFrame for smooth non-interrupting scroll
            requestAnimationFrame(() => {
                chatDisplay.scrollTo({
                    top: chatDisplay.scrollHeight,
                    behavior: 'smooth'
                });
            });
        };

        // Dynamic Message Appending and Animation
        const appendMessage = (isAI, message, isTyping = false, callback = null) => {
            const templateId = isAI ? 'ai-message-template' : 'user-message-template';
            const template = document.getElementById(templateId);

            if (!template) {
                console.error(`Template element '${templateId}' not found`);
                // Fallback: create simple message element
                const fallbackMessage = document.createElement('div');
                fallbackMessage.className = `flex ${isAI ? 'justify-start' : 'justify-end'} mb-4`;
                fallbackMessage.innerHTML = `
                    <div class="max-w-xs sm:max-w-lg ${isAI ? 'message-ai' : 'message-user'} p-4 rounded-2xl shadow-sm">
                        <p class="font-semibold ${isAI ? 'text-accent-600' : 'text-green-600'} mb-2 text-sm">
                            ${isAI ? 'AI Interviewer' : 'You'}
                        </p>
                        <p class="text-primary-700 text-sm leading-relaxed">${message}</p>
                    </div>
                `;
                chatDisplay.appendChild(fallbackMessage);
                smoothScrollToBottom();
                if (callback) callback();
                return;
            }

            const newMessageContainer = template.cloneNode(true);

            newMessageContainer.removeAttribute('id');
            newMessageContainer.classList.remove('hidden');

            const contentElement = newMessageContainer.querySelector('[data-message-content]');
            const messageBox = newMessageContainer.querySelector('div:last-child'); // The actual message box for animation

            chatDisplay.appendChild(newMessageContainer);
            smoothScrollToBottom();

            // Animate message box in
            setTimeout(() => {
                messageBox.classList.remove('opacity-0', 'translate-y-4');
                messageBox.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            if (isTyping) {
                // Start typing animation
                contentElement.textContent = ""; // Clear for animation
                contentElement.classList.add('typing-cursor');
                let i = 0;

                const typingInterval = setInterval(() => {
                    if (i < message.length) {
                        contentElement.textContent += message.charAt(i);
                        i++;
                        smoothScrollToBottom();
                    } else {
                        clearInterval(typingInterval);
                        contentElement.classList.remove('typing-cursor');
                        if (callback) callback();
                    }
                }, AI_RESPONSE_SIM_DELAY);

                typingTimeout = typingInterval; // Store for clearing on pause/reset
            } else {
                // Immediate text display
                contentElement.textContent = message;
                if (callback) callback();
            }
        };

        // --- Timer Functions ---
        const startAnswerTimer = () => {
            if (answerTimerInterval) clearInterval(answerTimerInterval);
            currentAnswerSeconds = ANSWER_TIME_LIMIT;
            answerTimerElement.textContent = formatTime(currentAnswerSeconds);
            answerTimerElement.classList.remove('bg-red-700/50', 'timer-critical');

            answerTimerInterval = setInterval(() => {
                if (currentAnswerSeconds > 0) {
                    currentAnswerSeconds--;
                    answerTimerElement.textContent = formatTime(currentAnswerSeconds);
                    if (currentAnswerSeconds <= 10) {
                        answerTimerElement.classList.add('bg-red-700/50', 'timer-critical'); // Glowing Red Effect
                    }
                } else {
                    stopUserTurn(true); // Time is up
                }
            }, 1000);
        };

        const stopAnswerTimer = () => {
            clearInterval(answerTimerInterval);
        };

        // --- UI & Control Functions ---
        const resetUI = () => {
            // State Reset
            isPaused = false;
            sessionActive = false;
            isUserRecording = false;
            isAITalking = false;
            currentQuestionIndex = 0;
            stopAnswerTimer();
            clearTimeout(typingTimeout);

            // Button/Control Reset
            startSessionBtn.disabled = false;
            endSessionBtn.disabled = true;
            pauseBtn.disabled = true;
            pauseText.textContent = 'Pause';
            aiButton.disabled = true;
            userButton.disabled = true;
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            aiButton.classList.remove('pulse-glow-purple');
            userButton.classList.remove('pulse-glow-pink');

            // Text/Display Reset
            answerTimerElement.textContent = "00:00";
            answerTimerElement.classList.remove('bg-red-700/50', 'timer-critical');
            aiStatusText.textContent = "Click 'Start Session' below to begin your interactive interview.";

            // Icon/Prompt Reset
            aiPromptText.classList.remove('opacity-100');
            userPromptText.classList.remove('opacity-100');
            aiMicIcon.setAttribute('data-lucide', 'message-square-text');
            userMicIcon.setAttribute('data-lucide', 'mic');
            lucide.createIcons();

            // Clear all messages except the welcome message
            const initialMessage = chatDisplay.querySelector('.flex:first-child');
            chatDisplay.innerHTML = '';
            chatDisplay.appendChild(initialMessage);
        };

        const togglePause = () => {
            if (!sessionActive) return;

            isPaused = !isPaused;
            if (isPaused) {
                stopAnswerTimer();
                clearTimeout(typingTimeout);

                pauseText.textContent = 'Resume';
                aiStatusText.textContent = "Session PAUSED";

                // Disable all interaction buttons and animations
                aiButton.disabled = true;
                userButton.disabled = true;
                chatInput.disabled = true;
                sendBtn.disabled = true;
                aiButton.classList.remove('pulse-glow-purple');
                userButton.classList.remove('pulse-glow-pink');
            } else {
                pauseText.textContent = 'Pause';
                // Resume logic: AI turn or User turn?
                if (isAITalking) {
                    aiStatusText.textContent = "AI is generating question/feedback. Please wait...";
                } else if (currentQuestionIndex > 0) {
                    aiStatusText.textContent = "Your response is processed. Click the AI button to get feedback and the next question.";
                    aiButton.disabled = false; // Allow AI to be triggered again
                } else {
                    aiStatusText.textContent = "Click AI button for first question.";
                    aiButton.disabled = false;
                }
            }
        };

        const setButtonStatesForUserTurn = (enable) => {
            // This function handles enabling/disabling of user input methods
            chatInput.disabled = !enable;
            userButton.disabled = !enable;
            sendBtn.disabled = !enable; // Send button enabled when input is enabled
        };

        // --- Conversation Flow Functions ---
        const startSession = async () => {
            try {
                // Start session in backend
                const response = await fetch('/dashboard/start_session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (data.success) {
                    currentSessionId = data.session_id;
                    sessionActive = true;
                    startSessionBtn.disabled = true;
                    endSessionBtn.disabled = false;
                    pauseBtn.disabled = false;

                    aiStatusText.textContent = "Session Active. Click AI button to begin the interview.";
                    aiButton.disabled = false;
                    aiPromptText.textContent = "Ask First Q";
                    aiPromptText.classList.add('opacity-100');
                    aiButton.classList.add('pulse-glow-purple');
                } else {
                    showModal(`Error starting session: ${data.error}`);
                }
            } catch (error) {
                console.error('Error starting session:', error);
                showModal('Error starting interview session. Please try again.');
            }
        };

        const startAITurn = async () => {
            if (isPaused || isAITalking) return;

            if (currentQuestionIndex >= (window.interviewConfig.numQuestions || 10)) {
                showModal("Interview Complete! Generating your feedback report...", false, () => endSessionBtn.click());
                return;
            }

            isAITalking = true;
            setButtonStatesForUserTurn(false);
            aiButton.disabled = true;

            // UI update for AI speaking
            aiButton.classList.add('pulse-glow-purple');
            aiPromptText.textContent = "AI Speaking...";
            aiPromptText.classList.add('opacity-100');
            aiMicIcon.setAttribute('data-lucide', 'headphones');
            aiStatusText.textContent = `AI is generating question ${currentQuestionIndex + 1}...`;
            lucide.createIcons();

            try {
                const question = await generateQuestionWithGemini(currentQuestionIndex + 1);

                // Simulate AI generating and speaking a question with typing effect
                appendMessage(true, question, true, () => {
                    // Animation Complete Callback
                    isAITalking = false;
                    aiButton.classList.remove('pulse-glow-purple');
                    aiPromptText.textContent = "AI Waiting";

                    // Next step: Enable user to answer
                    aiStatusText.textContent = "Ready! Respond via text or voice mic below.";
                    setButtonStatesForUserTurn(true);
                    userPromptText.classList.add('opacity-100');

                    // Start answer timer implicitly with the user's turn
                    startAnswerTimer();
                    chatInput.focus();
                });
            } catch (error) {
                console.error('Error in startAITurn:', error);
                aiStatusText.textContent = "Error generating question. Please try again.";
                isAITalking = false;
                aiButton.disabled = false;
            }
        };

        const startUserRecording = () => {
            if (isPaused || isAITalking || isUserRecording) return;

            if (!speechRecognition) {
                showModal("Speech recognition is not supported in your browser. Please type your answer instead.");
                return;
            }

            isRecording = true;
            isUserRecording = true;

            // UI update for User recording
            userButton.classList.add('pulse-glow-pink');
            userPromptText.textContent = "Recording...";
            userMicIcon.setAttribute('data-lucide', 'mic-off');
            aiButton.disabled = true;
            chatInput.disabled = true; // Disable text input while recording
            aiStatusText.textContent = "Recording your response. Speak now...";
            lucide.createIcons();

            // Start speech recognition
            try {
                speechRecognition.start();
            } catch (error) {
                console.error('Speech recognition error:', error);
                showModal("Error starting speech recognition. Please type your answer instead.");
                stopUserRecording();
            }
        };

        const stopUserRecording = () => {
            if (speechRecognition && isRecording) {
                speechRecognition.stop();
            }
            isRecording = false;
            isUserRecording = false;

            // Reset UI
            userButton.classList.remove('pulse-glow-pink');
            userPromptText.textContent = "Voice";
            userMicIcon.setAttribute('data-lucide', 'mic');
            chatInput.disabled = false;
            lucide.createIcons();
        };

        const stopUserTurn = async (timedOut = false, userText = null) => {
            if (!sessionActive || !currentSessionId) return;

            stopAnswerTimer();
            stopUserRecording();

            const response = userText || (timedOut ? "Time's up! I apologize for not completing my answer in time." : "I need more time to formulate my response.");

            // Add user message to chat
            appendMessage(false, response, false);

            // UI update for processing user answer
            userPromptText.textContent = "Processing...";
            userMicIcon.setAttribute('data-lucide', 'loader-2');
            lucide.createIcons();

            setButtonStatesForUserTurn(false);
            chatInput.value = '';

            try {
                // Submit answer to backend
                const submitResponse = await fetch('/dashboard/submit_answer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        answer: response,
                        question_number: currentQuestionIndex + 1,
                        session_id: currentSessionId,
                        time_taken: ANSWER_TIME_LIMIT - currentAnswerSeconds
                    })
                });

                const data = await submitResponse.json();
                if (data.success) {
                    // Show AI feedback
                    if (data.feedback) {
                        setTimeout(() => {
                            appendMessage(true, data.feedback, true);
                        }, 500);
                    }

                    // Enable next question after feedback
                    setTimeout(() => {
                        userPromptText.classList.remove('opacity-100');
                        userMicIcon.setAttribute('data-lucide', 'mic');
                        lucide.createIcons();

                        currentQuestionIndex++;

                        if (currentQuestionIndex >= 10 || currentQuestionIndex >= data.session_progress?.total) {
                            aiStatusText.textContent = "Interview complete! Click End Session to finish.";
                            endSessionBtn.disabled = false;
                        } else {
                            aiButton.disabled = false;
                            aiButton.classList.add('pulse-glow-purple');
                            aiPromptText.textContent = "Ask Next Q";
                            aiPromptText.classList.add('opacity-100');
                            aiStatusText.textContent = "Click the AI button for the next question.";
                        }

                        smoothScrollToBottom();
                    }, 2000);
                } else {
                    showModal(`Error submitting answer: ${data.error}`);
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                showModal('Error submitting answer. Please try again.');
            }
        };

        // Get CSRF token
        const csrfToken = window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

        // --- Gemini API Integration ---
        async function generateQuestionWithGemini(questionIndex) {
            try {
                const response = await fetch('/dashboard/generate_question/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        question_number: questionIndex,
                        context: interviewContext,
                        previous_answers: getPreviousAnswers(),
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();
                if (data.success) {
                    return data.question;
                } else {
                    throw new Error(data.error || 'Failed to generate question');
                }
            } catch (error) {
                console.error('Error generating question:', error);
                // Fallback questions
                const fallbackQuestions = [
                    "Tell me about yourself and your background.",
                    `Walk me through your experience with ${interviewContext.skills.split(',')[0]}.`,
                    "Describe a challenging project you've worked on and how you overcame obstacles.",
                    "How do you stay updated with the latest technologies in your field?",
                    "Walk me through your problem-solving approach when facing a complex technical issue."
                ];
                return fallbackQuestions[(questionIndex - 1) % fallbackQuestions.length];
            }
        }

        function getPreviousAnswers() {
            const messages = chatDisplay.querySelectorAll('.flex.justify-end [data-message-content]');
            return Array.from(messages).map(msg => msg.textContent).slice(0, -1); // Exclude current
        }

        async function evaluateAnswerWithGemini(answer) {

            try {
                const response = await fetch('/dashboard/evaluate_answer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        answer: answer,
                        question_number: currentQuestionIndex,
                        context: interviewContext
                    })
                });

                const data = await response.json();
                if (data.success) {
                    return data.feedback;
                }
            } catch (error) {
                console.error('Error evaluating answer:', error);
            }
            return "Thank you for your response. Let's move to the next question.";
        }

        // --- Event Listeners ---
        startSessionBtn.addEventListener('click', startSession);
        pauseBtn.addEventListener('click', togglePause);

        startOverBtn.addEventListener('click', () => {
            showModal('Are you sure you want to restart? All progress will be reset.', true, (confirmed) => {
                if (confirmed) {
                    resetUI();
                    showModal("Session restarted successfully! Click 'Start Session' to begin.");
                }
            });
        });

        endSessionBtn.addEventListener('click', () => {
            showModal('Do you want to end the session? Analysis data will be saved.', true, async (confirmed) => {
                if (confirmed && currentSessionId) {
                    try {
                        const response = await fetch('/dashboard/end_session/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({
                                session_id: currentSessionId
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            resetUI();
                            showModal(`Session completed! You answered ${data.session_summary.questions_answered} questions in ${data.session_summary.duration_minutes} minutes.`);
                        } else {
                            showModal(`Error ending session: ${data.error}`);
                        }
                    } catch (error) {
                        console.error('Error ending session:', error);
                        showModal('Error ending session. Please try again.');
                    }
                }
            });
        });

        aiButton.addEventListener('click', startAITurn);

        // User Mic/Send Button Logic
        userButton.addEventListener('click', () => {
            if (!isUserRecording) {
                startUserRecording();
            } else {
                stopUserRecording();
            }
        });

        // Text Input & Send Logic
        const handleTextSubmission = () => {
            const text = chatInput.value.trim();
            if (text && sessionActive && !isAITalking) {
                stopUserTurn(false, text); // Submit text as the user response
            }
        };

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleTextSubmission();
                e.preventDefault(); // Prevent default form submission
            }
        });

        sendBtn.addEventListener('click', handleTextSubmission);

        // --- Initial Setup ---
        resetUI();
    });
</script>
{% endblock %}